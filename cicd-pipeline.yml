---
- name: CI/CD Full Pipeline - Health Check
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    sonar_token: "sqa_9a98406ea100ba504788392dff1b907ab7fc4655"
    harbor_url: "http://10.40.92.46:30089"
    argocd_url: "http://10.40.92.46:30102"
    sonar_url:  "http://10.40.92.46:30902"

  tasks:

  - name: "1/5 SonarQube - Proje Kontrol"
    uri:
      url: "{{ sonar_url }}/api/projects/search"
      method: GET
      user: "{{ sonar_token }}"
      password: ""
      force_basic_auth: yes
      status_code: [200]
    register: sonar_result
    ignore_errors: yes

  - name: "SonarQube SonuÃ§"
    debug:
      msg: "{{ 'âœ… SonarQube OK - Projeler: ' + (sonar_result.json.components | map(attribute='name') | list | string) if sonar_result.status == 200 else 'âŒ SonarQube DOWN' }}"
    ignore_errors: yes

  - name: "2/5 Harbor - Registry Kontrol"
    uri:
      url: "{{ harbor_url }}/api/v2.0/ping"
      method: GET
      url_username: "admin"
      url_password: "Harbor12345"
      force_basic_auth: yes
      status_code: [200]
    register: harbor_result
    ignore_errors: yes

  - name: "Harbor SonuÃ§"
    debug:
      msg: "{{ 'âœ… Harbor OK' if harbor_result.status == 200 else 'âŒ Harbor DOWN' }}"

  - name: "3/5 ArgoCD - Uygulama Kontrol"
    uri:
      url: "{{ argocd_url }}"
      method: GET
      status_code: [200, 301, 302, 307]
    register: argocd_result
    ignore_errors: yes

  - name: "ArgoCD SonuÃ§"
    debug:
      msg: "{{ 'âœ… ArgoCD OK' if argocd_result.status in [200,301,302,307] else 'âŒ ArgoCD DOWN' }}"

  - name: "4/5 TÃ¼m Platform Health Check"
    uri:
      url: "{{ item.url }}"
      method: GET
      status_code: [200, 201, 301, 302, 307, 401, 403]
      timeout: 5
      validate_certs: no
    register: health
    ignore_errors: yes
    loop:
      - { name: "Semaphore",   url: "http://10.40.92.46:30860" }
      - { name: "Grafana",     url: "http://10.40.92.46:30300" }
      - { name: "Prometheus",  url: "http://10.40.92.46:30090" }
      - { name: "Vault",       url: "http://10.40.92.46:30820" }
      - { name: "MinIO",       url: "http://10.40.92.46:30901" }
      - { name: "Nexus",       url: "http://10.40.92.46:30810" }
      - { name: "Trivy",       url: "http://10.40.92.46:30809" }
      - { name: "Consul",      url: "http://10.40.92.46:30851" }
      - { name: "Jaeger",      url: "http://10.40.92.46:30686" }
      - { name: "DynamoDB",    url: "http://10.40.92.46:30801" }
      - { name: "ElasticMQ",   url: "http://10.40.92.46:30325" }

  - name: "Platform Health SonuÃ§larÄ±"
    debug:
      msg: "{{ 'âœ…' if item.status | default(-1) in [200,201,301,302,307,401,403] else 'âŒ' }} {{ item.item.name }}"
    loop: "{{ health.results }}"
    ignore_errors: yes

  - name: "5/5 Pipeline Ã–zet"
    debug:
      msg:
        - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        - "â•‘   ğŸ‰ DevOps Platform CI/CD Pipeline      â•‘"
        - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        - "â•‘  SonarQube â†’ http://10.40.92.46:30902   â•‘"
        - "â•‘  Harbor    â†’ http://10.40.92.46:30089   â•‘"
        - "â•‘  ArgoCD    â†’ http://10.40.92.46:30102   â•‘"
        - "â•‘  Semaphore â†’ http://10.40.92.46:30860   â•‘"
        - "â•‘  Grafana   â†’ http://10.40.92.46:30300   â•‘"
        - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
