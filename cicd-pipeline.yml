---
- name: CI/CD Full Pipeline - Health Check
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    sonar_token: "sqa_623ef9ef96c373ace6ef53913cd9b8c974bdaa02"

  tasks:

  - name: "1/6 SonarQube - Proje Kontrol"
    uri:
      url: "http://10.40.92.46:30902/api/projects/search"
      method: GET
      user: "{{ sonar_token }}"
      password: ""
      force_basic_auth: yes
      status_code: [200]
    register: sonar_result
    ignore_errors: yes

  - name: "SonarQube SonuÃ§"
    debug:
      msg: "âœ… SonarQube: {{ sonar_result.json.components | map(attribute='name') | list }}"
    when: sonar_result.status == 200
    ignore_errors: yes

  - name: "2/6 Harbor - Registry Kontrol"
    uri:
      url: "http://10.40.92.46:30088"
      method: GET
      status_code: [200, 301, 302]
    register: harbor_result
    ignore_errors: yes

  - name: "Harbor SonuÃ§"
    debug:
      msg: "{{ 'âœ… Harbor: OK' if harbor_result.status in [200,301,302] else 'âŒ Harbor: DOWN' }}"

  - name: "3/6 ArgoCD - Kontrol"
    uri:
      url: "http://10.40.92.46:30102"
      method: GET
      status_code: [200, 301, 302, 307]
    register: argocd_result
    ignore_errors: yes

  - name: "ArgoCD SonuÃ§"
    debug:
      msg: "{{ 'âœ… ArgoCD: OK' if argocd_result.status in [200,301,302,307] else 'âŒ ArgoCD: DOWN' }}"

  - name: "4/6 TÃ¼m Servisler Health Check"
    uri:
      url: "{{ item.url }}"
      method: GET
      status_code: [200, 201, 301, 302, 307, 401, 403]
      timeout: 5
    register: health
    ignore_errors: yes
    loop:
      - { name: "Semaphore",   url: "http://10.40.92.46:30860" }
      - { name: "Grafana",     url: "http://10.40.92.46:30300" }
      - { name: "Prometheus",  url: "http://10.40.92.46:30090" }
      - { name: "Vault",       url: "http://10.40.92.46:30820" }
      - { name: "MinIO",       url: "http://10.40.92.46:30901" }
      - { name: "Nexus",       url: "http://10.40.92.46:30810" }
      - { name: "SonarQube",   url: "http://10.40.92.46:30902" }
      - { name: "Trivy",       url: "http://10.40.92.46:30809" }
      - { name: "NeuVector",   url: "https://10.40.92.46:30701" }
      - { name: "Consul",      url: "http://10.40.92.46:30851" }
      - { name: "Jaeger",      url: "http://10.40.92.46:30686" }

  - name: "Health Check SonuÃ§larÄ±"
    debug:
      msg: "{{ 'âœ…' if item.status | default(-1) in [200,201,301,302,307,401,403] else 'âŒ' }} {{ item.item.name }}: HTTP {{ item.status | default('TIMEOUT') }}"
    loop: "{{ health.results }}"
    ignore_errors: yes

  - name: "5/6 SonarQube - Proje Analiz Tetikle"
    uri:
      url: "http://10.40.92.46:30902/api/ce/submit"
      method: POST
      user: "{{ sonar_token }}"
      password: ""
      force_basic_auth: yes
      body_format: form-urlencoded
      body:
        projectKey: "techstore"
        projectName: "TechStore"
      status_code: [200, 201, 400, 404]
    register: analysis
    ignore_errors: yes

  - name: "6/6 Pipeline Ã–zet"
    debug:
      msg:
        - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        - "â•‘   ğŸ‰ CI/CD PIPELINE TAMAMLANDI!       â•‘"
        - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        - "SonarQube  â†’ http://10.40.92.46:30902"
        - "Harbor     â†’ http://10.40.92.46:30088"
        - "ArgoCD     â†’ http://10.40.92.46:30102"
        - "Semaphore  â†’ http://10.40.92.46:30860"
        - "Grafana    â†’ http://10.40.92.46:30300"
